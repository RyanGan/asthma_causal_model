---
title: "Okland Kicks Asthma MSM"
author: "Ryan_Gan"
date: "April 25, 2017"
output: html_document
---

## Marginal Structural Model

General purpose of this project is to try and estimate an MSM that doesn't have an ETA violation.

## Replication of Sheryl's Dissertation Results

Importing SAS files of Oakland Kicks Asthma data provided by Sheryl.

```{r library setup}
library(haven) # library for importing SAS files
library(tidyverse) # data wrangle package
library(broom)
library(tmle)
library(SuperLearner)
library(MASS)
```

```{r import and data wrangle}
no2layer <- read_sas("./no2layer.sas7bdat") %>% # summary of NO2
  select(OKAID, NO2)
  
no2_col_names <- colnames(no2layer) %>% tolower() # lowercase all col names
colnames(no2layer) <- no2_col_names # assign lowercase col names to df

#head(no2layer) # check out the first 6 lines

okawork <- read_sas("./okawork1.sas7bdat")
#glimpse(okawork) # 433 variables; not priting

# join okawork with no2layer by okaid
asthma_df <- okawork %>% right_join(no2layer, by = "okaid") %>% 
  # create ed visit variable from sh_11 var (assuming 1=event)
  mutate(edvisit = ifelse(sh_11 == 1, 1,
                   ifelse(sh_11 == 2, 0, NA))) %>% 
  # filter out missing edvisits
  filter(!is.na(edvisit)) %>%
  # filter to prevalent asthma cases
  select(edvisit, asthma, inbuff, mfi_t, adengonly, eslgood, piprlt50, pctlata,
         ph75_100k, pctutilinc, pctotown, pctnofuel, kidspanengg, pkgt6sp1,
         regcomm, commcomr, urbanres) %>% 
  filter(asthma == 1)
# in Sheryl's SAS code, she has regcomm_perc but I could not find it, so using
# regcomm for now.

```

Calculating some of the descriptive tables in Sheryl's dissertation.

```{r descriptives}
xtabs(~ edvisit + inbuff, data = asthma_df)

```

```{r prev asthma standard estimates}
# prevalent asthma 
# crude model
crude_mod <- tidy(glm(edvisit ~ inbuff, data = asthma_df,
                    family = "binomial"(link = "logit")))

# crude odds ratio and 95%CI
vals <- round(exp(c(crude_mod[2,2], crude_mod[2,2]-1.96*crude_mod[2,3], 
      crude_mod[2,2]+1.96*crude_mod[2,3])),2)
rbind(c("OR", "Lower_95", "Upper_95"), vals)


# adjusted model
adj_mod <- tidy(glm(edvisit ~ inbuff + mfi_t + adengonly + eslgood + 
          piprlt50 + pctlata + ph75_100k + pctutilinc + pctotown + pctnofuel + 
          kidspanengg + pkgt6sp1 + regcomm + commcomr + urbanres, 
          data = asthma_df, family = "binomial"(link="logit")))

# adjusted odds ratio and 95%CI
vals <- round(exp(c(adj_mod[2,2], adj_mod[2,2]-1.96*adj_mod[2,3], 
      adj_mod[2,2]+1.96*adj_mod[2,3])),2)
rbind(c("OR", "Lower_95", "Upper_95"), vals)
```

### TMLE

Not really sure what covariates to feed to the models, but I'm going to just mess around with TMLE for now with the dataframes I have.

```{r tmle msm}
tmle_mod <- tmle(Y = asthma_df$edvisit, A = asthma_df$inbuff, 
                 W = subset(asthma_df, select = -c(edvisit, inbuff, asthma)),
                 Q.SL.library = c("SL.nnet", "SL.glm", "SL.randomForest", "SL.step",
                                  "SL.glm.interaction"), 
                 g.SL.library = c("SL.nnet", "SL.glm", "SL.randomForest", "SL.step",
                                  "SL.glm.interaction"), 
                 family = "binomial")
tmle_mod
```


